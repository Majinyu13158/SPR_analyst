# å¤šæ•°æ®æ‹Ÿåˆå®ç°æ€»ç»“

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. å¤šé€‰æ•°æ®æºå¯¹è¯æ¡†
**æ–‡ä»¶**: `src/views/dialogs/fitting_method_dialog.py`

**æ”¹åŠ¨**:
- å°†å•é€‰ä¸‹æ‹‰æ¡†(`QComboBox`)æ”¹ä¸ºå¤šé€‰åˆ—è¡¨(`QListWidget` + `MultiSelection`)
- æ·»åŠ å¤é€‰æ¡†æ”¯æŒï¼Œç”¨æˆ·å¯å‹¾é€‰å¤šä¸ªæ•°æ®
- è¿”å›å€¼ä»å•ä¸ª`data_id`æ”¹ä¸ºåˆ—è¡¨`data_ids`
- å¯¹è¯æ¡†æ ‡é¢˜æç¤ºï¼š"å¯å¤šé€‰ï¼ŒLocalBivariateå°†åˆå¹¶æ‰€é€‰æ•°æ®åˆ—"

**æ•ˆæœ**:
```
æ•°æ®æºé€‰æ‹©ï¼š
â˜‘ [1] å¤šå¾ªç¯igg (8æµ“åº¦)  (15, 9)
â˜‘ [2] å¯¹ç…§ç»„æ•°æ®  (15, 5)
â˜ [3] é‡å¤å®éªŒ  (15, 7)
```

---

### 2. å»æ‰é¢„å…ˆé€‰ä¸­æ•°æ®çš„é™åˆ¶
**æ–‡ä»¶**: `src/controllers/main_controller_full.py`

**æ”¹åŠ¨**:
- åˆ é™¤äº†`_on_fit_from_menu()`ä¸­çš„æ£€æŸ¥ï¼š
  ```python
  # æ—§ä»£ç ï¼š
  if self.current_data_id is None:
      self.view.show_error("æ“ä½œå¤±è´¥", "è¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹")
      return
  
  # æ–°ä»£ç ï¼šç›´æ¥å¼¹å‡ºå¯¹è¯æ¡†ï¼Œæ— éœ€é¢„å…ˆé€‰ä¸­
  ```

**æ•ˆæœ**: 
- ç”¨æˆ·å¯ä»¥ç›´æ¥ç‚¹å‡»èœå•/å·¥å…·æ çš„"æ‹Ÿåˆ"æŒ‰é’®
- å¯¹è¯æ¡†å¼¹å‡ºåé€‰æ‹©æ•°æ®æº
- æ”¯æŒ"ä»æ— é€‰ä¸­çŠ¶æ€"å¼€å§‹æ‹Ÿåˆæµç¨‹

---

### 3. å¤šæ•°æ®åˆå¹¶æ‹Ÿåˆ
**æ–‡ä»¶**: `src/controllers/main_controller_full.py`

**æ–°æ–¹æ³•**: `on_fitting_requested_multi(data_ids, method)`

**é€»è¾‘**:
```python
# æ­¥éª¤1ï¼šæ”¶é›†æ‰€æœ‰DataFrame
for data_id in data_ids:
    data = self.data_manager.get_data(data_id)
    all_dataframes.append(data.dataframe.copy())

# æ­¥éª¤2ï¼šåˆå¹¶ä¸ºå®½è¡¨
# å‡è®¾æ¯ä¸ªDataFrameæ ¼å¼ï¼šTime | æµ“åº¦1 | æµ“åº¦2 | ...
merged_df = ç¬¬ä¸€ä¸ªDataFrame.copy()
for å…¶ä»–DataFrame in all_dataframes[1:]:
    # åªå–æµ“åº¦åˆ—ï¼ˆè·³è¿‡Timeåˆ—ï¼‰
    merged_df[æµ“åº¦åˆ—] = å…¶ä»–DataFrame[æµ“åº¦åˆ—]

# æ­¥éª¤3ï¼šåˆ›å»ºä¸´æ—¶åˆå¹¶Dataå¯¹è±¡
combined_data_id = self.data_manager.add_data(
    name="åˆå¹¶æ•°æ®(Nç»„): ...",
    dataframe=merged_df
)

# æ­¥éª¤4ï¼šä¸€æ¬¡æ€§è°ƒç”¨LocalBivariate
self.on_fitting_requested(combined_data_id, method)
```

**å…³é”®**:
- **ä¸æ˜¯**é€ä¸ªè°ƒç”¨æ‹Ÿåˆï¼ˆä¸æ˜¯`for data_id: fit(data_id)`ï¼‰
- **è€Œæ˜¯**å…ˆåˆå¹¶åæ‹Ÿåˆï¼ˆ`merge_all() â†’ fit_once()`ï¼‰
- ç¬¦åˆLocalBivariateè®¾è®¡ï¼šåŒæ—¶å¤„ç†å¤šæµ“åº¦æ•°æ®

**ç¤ºä¾‹**:
```
é€‰ä¸­3ä¸ªæ•°æ®ï¼š
- Data1: Time | 0.0 | 1.0e-9
- Data2: Time | 2.0e-9 | 4.0e-9
- Data3: Time | 8.0e-9

åˆå¹¶åï¼š
Time | 0.0 | 1.0e-9 | 2.0e-9 | 4.0e-9 | 8.0e-9

ä¸€æ¬¡æ€§è°ƒç”¨LocalBivariate â†’ åŒæ—¶æ‹Ÿåˆ5æ¡æ›²çº¿
```

---

### 4. ä¿®å¤ç»“æœè¡¨æ ¼æ ¼å¼åŒ–é”™è¯¯
**æ–‡ä»¶**: `src/views/widgets/data_tables.py`

**é—®é¢˜**: 
```python
# æ—§ä»£ç ï¼šæ‰€æœ‰å€¼éƒ½ç”¨ç§‘å­¦è®¡æ•°æ³•
self.setItem(row_idx, 1, self._create_item(f"{value_tuple[0]:.6e}"))
# å½“valueæ˜¯å­—ç¬¦ä¸²æ—¶æŠ¥é”™ï¼šUnknown format code 'e' for object of type 'str'
```

**ä¿®å¤**:
```python
# æ–°ä»£ç ï¼šåˆ¤æ–­ç±»å‹
if isinstance(val, str):
    self.setItem(row_idx, 1, self._create_item(val))  # å­—ç¬¦ä¸²ç›´æ¥æ˜¾ç¤º
elif isinstance(val, (int, float)) and not isinstance(val, bool):
    self.setItem(row_idx, 1, self._create_item(f"{val:.6e}"))  # æ•°å€¼ç”¨ç§‘å­¦è®¡æ•°æ³•
else:
    self.setItem(row_idx, 1, self._create_item(str(val)))  # å…¶ä»–ç±»å‹è½¬å­—ç¬¦ä¸²
```

**æ•ˆæœ**:
```
å‚æ•°å         å€¼                  è¯¯å·®        å•ä½
DataSource     åˆå¹¶æ•°æ®(3ç»„)...   -           -
Method         LocalBivariate     -           -
Rmax           4.523400e+01       -           RU
Kon            1.234500e+05       -           1/(M*s)
Koff           2.345600e-03       -           1/s
KD             1.901200e-08       -           M
```

---

### 5. ç»“æœæ˜¾ç¤ºå¢å¼º
**æ–‡ä»¶**: `src/controllers/main_controller_full.py`

**æ”¹åŠ¨**:
```python
# åœ¨æ‹Ÿåˆç»“æœä¸­æ·»åŠ å…ƒä¿¡æ¯
params_with_meta = {
    'DataSource': (data_source_name, None, ''),  # æ•°æ®æ¥æº
    'Method': (method, None, ''),                # æ‹Ÿåˆæ–¹æ³•
    **params_with_meta                           # åŸæœ‰å‚æ•°ï¼ˆRmax, Kon, Koff, KDï¼‰
}
result.set_parameters(params_with_meta)
```

**æ•ˆæœ**:
- ç”¨æˆ·å¯ä»¥æ¸…æ¥šçœ‹åˆ°æ¯æ¬¡æ‹Ÿåˆä½¿ç”¨çš„æ•°æ®æº
- å¯ä»¥åŒºåˆ†ä¸åŒæ–¹æ³•çš„ç»“æœ
- ä¾¿äºè¿½æº¯å’Œå¯¹æ¯”

---

## ğŸ“Š å®Œæ•´å·¥ä½œæµç¨‹

### å•æ•°æ®æ‹Ÿåˆ
```
1. ç”¨æˆ·ç‚¹å‡»"æ‹Ÿåˆ"ï¼ˆæ— éœ€é¢„å…ˆé€‰ä¸­ï¼‰
   â†“
2. å¼¹å‡ºå¯¹è¯æ¡†ï¼Œå‹¾é€‰1ä¸ªæ•°æ®
   â†“
3. é€‰æ‹©æ–¹æ³•ï¼ˆå¦‚LocalBivariateï¼‰
   â†“
4. è°ƒç”¨ on_fitting_requested(data_id, method)
   â†“
5. æ˜¾ç¤ºç»“æœï¼ˆåŒ…å«DataSourceå’ŒMethodï¼‰
```

### å¤šæ•°æ®åˆå¹¶æ‹Ÿåˆ
```
1. ç”¨æˆ·ç‚¹å‡»"æ‹Ÿåˆ"ï¼ˆæ— éœ€é¢„å…ˆé€‰ä¸­ï¼‰
   â†“
2. å¼¹å‡ºå¯¹è¯æ¡†ï¼Œå‹¾é€‰å¤šä¸ªæ•°æ®ï¼ˆå¦‚3ä¸ªï¼‰
   â†“
3. é€‰æ‹©æ–¹æ³•ï¼ˆå¦‚LocalBivariateï¼‰
   â†“
4. è°ƒç”¨ on_fitting_requested_multi([data_ids], method)
   â”œâ”€ æ”¶é›†3ä¸ªDataFrame
   â”œâ”€ åˆå¹¶ä¸ºå®½è¡¨ï¼ˆTime + æ‰€æœ‰æµ“åº¦åˆ—ï¼‰
   â”œâ”€ åˆ›å»ºä¸´æ—¶åˆå¹¶Dataå¯¹è±¡
   â””â”€ è°ƒç”¨ on_fitting_requested(combined_id, method)
   â†“
5. LocalBivariateä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰æµ“åº¦
   â†“
6. æ˜¾ç¤ºç»“æœï¼ˆDataSourceæ˜¾ç¤º"åˆå¹¶æ•°æ®(3ç»„): ..."ï¼‰
```

---

## ğŸ¯ å…³é”®è®¾è®¡ç†å¿µ

### LocalBivariateçš„æ­£ç¡®ç”¨æ³•
**é”™è¯¯åšæ³•** âŒ:
```python
# å¯¹æ¯ä¸ªæ•°æ®å•ç‹¬è°ƒç”¨
for data_id in data_ids:
    fit_data(data_id)  # 3æ¬¡ç‹¬ç«‹æ‹Ÿåˆï¼Œç»“æœä¸ä¸€è‡´
```

**æ­£ç¡®åšæ³•** âœ…:
```python
# å…ˆåˆå¹¶ï¼Œå†æ‹Ÿåˆ
merged_data = merge_all(data_ids)  # åˆå¹¶ä¸ºå®½è¡¨
fit_data(merged_data)              # 1æ¬¡æ‹Ÿåˆï¼ŒåŒæ—¶å¤„ç†æ‰€æœ‰æµ“åº¦
```

### ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ
1. **ç§‘å­¦åŸç†**: SPRå®éªŒä¸­ï¼Œä¸åŒæµ“åº¦çš„æ›²çº¿éœ€è¦**åŒæ—¶æ‹Ÿåˆ**æ‰èƒ½å‡†ç¡®è®¡ç®—åŠ¨åŠ›å­¦å‚æ•°ï¼ˆKon, Koff, KDï¼‰
2. **ç®—æ³•è®¾è®¡**: LocalBivariateå†…éƒ¨ä½¿ç”¨å…¨å±€ä¼˜åŒ–ï¼Œéœ€è¦çœ‹åˆ°æ‰€æœ‰æµ“åº¦çš„æ•°æ®æ‰èƒ½æ‰¾åˆ°æœ€ä¼˜è§£
3. **ç»“æœä¸€è‡´æ€§**: åˆå¹¶æ‹Ÿåˆä¿è¯æ‰€æœ‰æ›²çº¿ä½¿ç”¨ç›¸åŒçš„Kon/Koffå‚æ•°

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ•°æ®æ ¼å¼è¦æ±‚
æ‰€æœ‰å‚ä¸åˆå¹¶çš„DataFrameå¿…é¡»ï¼š
1. ç¬¬ä¸€åˆ—æ˜¯`Time`ï¼ˆæˆ–`time`, `XValue`, `X`ï¼‰
2. åç»­åˆ—æ˜¯æµ“åº¦å€¼ï¼ˆåˆ—åå¿…é¡»æ˜¯æ•°å€¼ï¼Œå¦‚`0.0`, `1.0e-9`ï¼‰
3. æ—¶é—´ç‚¹æ•°é‡ä¸€è‡´

### åˆå¹¶ç­–ç•¥
```python
# DataFrame1: Time | 0.0 | 1.0e-9
# DataFrame2: Time | 2.0e-9 | 4.0e-9

# åˆå¹¶å:
merged = DataFrame1.copy()              # ä¿ç•™Timeå’Œæ‰€æœ‰æµ“åº¦åˆ—
merged['2.0e-9'] = DataFrame2['2.0e-9'] # æ·»åŠ DataFrame2çš„æµ“åº¦åˆ—
merged['4.0e-9'] = DataFrame2['4.0e-9']

# ç»“æœ: Time | 0.0 | 1.0e-9 | 2.0e-9 | 4.0e-9
```

### åˆ—åå†²çªå¤„ç†
```python
if col in merged_df.columns:
    # åˆ—åå·²å­˜åœ¨ï¼Œæ·»åŠ åç¼€é¿å…è¦†ç›–
    new_col_name = f"{col}_{idx}"
    merged_df[new_col_name] = df[col].values
```

---

## ğŸ“ æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯1ï¼šå•æ•°æ®æ‹Ÿåˆ
1. ä¸é€‰ä¸­ä»»ä½•æ ‘èŠ‚ç‚¹
2. ç‚¹å‡»èœå•"æ‹Ÿåˆ"
3. å‹¾é€‰1ä¸ªæ•°æ®
4. ç¡®è®¤æ‹ŸåˆæˆåŠŸï¼Œç»“æœæ˜¾ç¤ºæ­£ç¡®çš„DataSource

### æµ‹è¯•åœºæ™¯2ï¼šå¤šæ•°æ®åˆå¹¶æ‹Ÿåˆ
1. åŠ è½½å¤šä¸ªJSONï¼ˆæ¯ä¸ª8æµ“åº¦ï¼‰
2. ç‚¹å‡»èœå•"æ‹Ÿåˆ"
3. å‹¾é€‰3ä¸ªæ•°æ®
4. ç¡®è®¤ï¼š
   - åˆå¹¶åçš„DataFrameåˆ—æ•° = 1(Time) + 8Ã—3(æµ“åº¦) = 25
   - LocalBivariateä¸€æ¬¡æ€§å¤„ç†24æ¡æ›²çº¿
   - ç»“æœæ˜¾ç¤º"åˆå¹¶æ•°æ®(3ç»„): ..."

### æµ‹è¯•åœºæ™¯3ï¼šæ ¼å¼åŒ–æ˜¾ç¤º
1. å®Œæˆæ‹Ÿåˆ
2. åˆ‡æ¢åˆ°"æ‹Ÿåˆç»“æœ"Tab
3. ç¡®è®¤ï¼š
   - `DataSource`å’Œ`Method`æ˜¾ç¤ºä¸ºå­—ç¬¦ä¸²ï¼ˆæ— `.e+00`ï¼‰
   - `Rmax`, `Kon`, `Koff`, `KD`æ˜¾ç¤ºä¸ºç§‘å­¦è®¡æ•°æ³•
   - æ— æ ¼å¼åŒ–é”™è¯¯

---

## ğŸ‰ æ€»ç»“

**å·²å®ç°**:
- âœ… å¤šé€‰æ•°æ®æºï¼ˆå¤é€‰æ¡†ï¼‰
- âœ… å»æ‰é¢„å…ˆé€‰ä¸­é™åˆ¶
- âœ… å¤šæ•°æ®åˆå¹¶æ‹Ÿåˆï¼ˆä¸€æ¬¡æ€§è°ƒç”¨LocalBivariateï¼‰
- âœ… ç»“æœæ ¼å¼åŒ–ä¿®å¤ï¼ˆå­—ç¬¦ä¸²vsæ•°å€¼ï¼‰
- âœ… ç»“æœæ˜¾ç¤ºæ•°æ®æºå’Œæ–¹æ³•

**ç¬¦åˆéœ€æ±‚**:
- âœ… LocalBivariateæ”¯æŒåŒæ—¶å¤„ç†å¤šç»„æ•°æ®
- âœ… ä¸æ˜¯æ¯ç»„å•ç‹¬è°ƒç”¨ï¼Œè€Œæ˜¯åˆå¹¶åç»Ÿä¸€è°ƒç”¨
- âœ… æ‹Ÿåˆç»“æœåŒ…å«å®Œæ•´å‚æ•°ï¼ˆDataSource, Method, Rmax, Kon, Koff, KDï¼‰

**åç»­ä¼˜åŒ–**ï¼ˆå¯é€‰ï¼‰:
- ä»LocalBivariateåº•å±‚æå–çœŸå®çš„Kon/Koff/KDå€¼ï¼ˆç›®å‰æ˜¯å ä½/ä¼°è®¡ï¼‰
- æ”¯æŒæ‰‹åŠ¨è°ƒæ•´åˆå¹¶ç­–ç•¥ï¼ˆä¾‹å¦‚æŒ‡å®šå“ªäº›åˆ—å‚ä¸åˆå¹¶ï¼‰
- æ·»åŠ åˆå¹¶é¢„è§ˆï¼ˆæ˜¾ç¤ºåˆå¹¶åçš„å®½è¡¨ç»“æ„ï¼‰

