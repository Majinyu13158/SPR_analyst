# æ‹Ÿåˆé—®é¢˜çš„æ ¹æœ¬åŸå› åˆ†æ

## ğŸ” è°ƒç”¨é“¾è¿½è¸ª

### å½“å‰é¡¹ç›®çš„æ‹Ÿåˆæµç¨‹ï¼š

```
1. Controller.on_fit_data
   â†“
2. fit_data(method='LocalBivariate', x_data, y_data, dataframe=data.dataframe, data_obj=data)
   â†“
3. FittingWrapper._fit_local_bivariate
   â†“
4. æ£€æŸ¥DataFrameæ ¼å¼ â†’ è½¬æ¢ä¸ºå®½è¡¨ï¼ˆTime, 0.0ï¼‰
   â†“
5. ä¿å­˜ä¸´æ—¶Excel
   â†“
6. è°ƒç”¨model_runner(tmp_excel_path)
   â†“
7. LocalBivariateç®—æ³•è®¡ç®—
   â†“
8. è¿”å› (T_data, Y_data, Y_pred)
```

## âŒ é—®é¢˜1ï¼šæµ“åº¦ä¸º0å¯¼è‡´Y_predå…¨æ˜¯0

**å®é™…æµ‹è¯•ç»“æœ**ï¼š
```
[7] Y_predï¼ˆå‰5ä¸ªï¼‰:
[[0.]
 [0.]
 [0.]
 [0.]
 [0.]]

Rmax: 74.4947
kon: 1.0000e+06
koff: 1.0000e-02
KD: 1.0000e-08
```

**åŸå› **ï¼šLocalBivariateçš„æ¨¡å‹å…¬å¼ï¼ˆç¬¬56è¡Œï¼‰ï¼š
```python
Eq = Bmax_value * radioligands / (radioligands + Kd)
```

å½“`radioligands=0`ï¼ˆæˆ‘ä»¬ç”¨çš„åˆ—å`'0.0'`ï¼‰æ—¶ï¼š
```
Eq = Bmax_value * 0 / (0 + Kd) = 0
â†’ Yé¢„æµ‹ = 0 + 0 * (...) = 0
```

**è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ‹Ÿåˆç»“æœæ˜¯ç›´çº¿ï¼ˆå®é™…æ˜¯é›¶çº¿ï¼‰ï¼**

---

## âŒ é—®é¢˜2ï¼šæ•°æ®åŠ è½½æ–¹å¼é”™è¯¯

**JSONæ–‡ä»¶ä¿¡æ¯**ï¼š
```
æ–‡ä»¶å: å¤šå¾ªç¯igg_20240918163627L.json
CalculateFormula: 101          â† SingleCycleç®—æ³•æ ‡è¯†
æ ·æœ¬æ•°é‡: 8                     â† å¤šå¾ªç¯ï¼Œ8ä¸ªæ ·æœ¬ï¼
ç¬¬ä¸€ä¸ªæ ·æœ¬æµ“åº¦: 0.0            â† å¯èƒ½æ˜¯å‚è€ƒæ ·æœ¬
```

**å½“å‰åŠ è½½é€»è¾‘** (`data_model.py` ç¬¬143-145è¡Œ)ï¼š
```python
base_data = first_item.get('BaseData', [])  # åªåŠ è½½ç¬¬ä¸€ä¸ªæ ·æœ¬ï¼
if base_data:
    self.dataframe = pd.DataFrame(base_data)
```

**é—®é¢˜**ï¼š
1. **åªåŠ è½½äº†ç¬¬ä¸€ä¸ªæ ·æœ¬**ï¼ˆæµ“åº¦=0çš„å‚è€ƒæ ·æœ¬ï¼‰
2. **å¿½ç•¥äº†å…¶ä»–7ä¸ªæ ·æœ¬**
3. **LocalBivariateéœ€è¦å¤šæµ“åº¦æ•°æ®**ï¼ˆTime + æµ“åº¦1 + æµ“åº¦2 + ...ï¼‰

---

## âŒ é—®é¢˜3ï¼šç®—æ³•é€‰æ‹©é”™è¯¯

**LocalBivariateç®—æ³•çš„è®¾è®¡ç›®çš„**ï¼š
- ç”¨äº**å¤šæµ“åº¦**æ•°æ®ï¼ˆå¦‚0 nM, 10 nM, 20 nM, ...ï¼‰
- é€šè¿‡**åŒæ—¶æ‹Ÿåˆå¤šæ¡æ›²çº¿**æ¥ç¡®å®šåŠ¨åŠ›å­¦å‚æ•°
- è¾“å…¥æ ¼å¼ï¼šå®½è¡¨ï¼ˆTime | 0.0 | 10.0 | 20.0 | ...ï¼‰

**SingleCycleç®—æ³•çš„è®¾è®¡ç›®çš„** (æ ¹æ®æ–‡ä»¶åå’Œä»£ç )ï¼š
- ç”¨äº**å¤šå¾ªç¯**æ•°æ®ï¼ˆå¤šæ¬¡é‡å¤çš„ç»“åˆ-è§£ç¦»å¾ªç¯ï¼‰
- è¾“å…¥æ ¼å¼ï¼šå¯èƒ½æ˜¯æ¯ä¸ªå¾ªç¯ä½œä¸ºç‹¬ç«‹çš„æ®µ

**å½“å‰JSONæ•°æ®**ï¼š
- æ–‡ä»¶åï¼š`å¤šå¾ªç¯igg`
- `CalculateFormula: 101` â† åº”è¯¥ç”¨SingleCycle
- ä½†æˆ‘ä»¬ç”¨äº†LocalBivariateï¼

---

## ğŸ”‘ æ—§é¡¹ç›®æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

### æ¨æµ‹1ï¼šç®—æ³•è·¯ç”±é€»è¾‘

æ—§é¡¹ç›®å¯èƒ½æœ‰ç±»ä¼¼è¿™æ ·çš„é€»è¾‘ï¼š
```python
if data.attributes['fittingformula'] == 101:
    # ä½¿ç”¨SingleCycleç®—æ³•
    result = SingleCycleFitting(...)
elif data.attributes['fittingformula'] == 102:
    # ä½¿ç”¨LocalBivariateç®—æ³•
    result = LocalBivariateFitting(...)
```

### æ¨æµ‹2ï¼šå¤šæ ·æœ¬æ•°æ®æ„å»º

æ—§é¡¹ç›®å¯èƒ½ä¼šï¼š
```python
# å¯¹äºå¤šå¾ªç¯æ•°æ®
samples = data['CalculateDataList']
# æå–æ¯ä¸ªæ ·æœ¬çš„æµ“åº¦å’ŒBaseData
concentrations = [s['Concentration'] for s in samples]
base_data_list = [s['BaseData'] for s in samples]

# æ„å»ºå®½è¡¨
wide_df = build_wide_table(concentrations, base_data_list)
```

è€Œä¸æ˜¯åªç”¨ç¬¬ä¸€ä¸ªæ ·æœ¬ï¼

---

## âœ… æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šæ ¹æ®CalculateFormulaé€‰æ‹©ç®—æ³• âœ… æ¨è

```python
def on_fit_data(self, data_id, method):
    data = self.data_manager.get_data(data_id)
    
    # â­ æ ¹æ®JSONä¸­çš„fittingformulaè‡ªåŠ¨é€‰æ‹©ç®—æ³•
    formula = data.attributes.get('fittingformula')
    if formula == 101:
        method = 'SingleCycle'
    elif formula == 102:
        method = 'LocalBivariate'
    elif formula == 103:
        method = 'GlobalBivariate'
    
    fit_result = fit_data(method, x_data, y_data, ...)
```

### æ–¹æ¡ˆ2ï¼šæ­£ç¡®åŠ è½½å¤šå¾ªç¯æ•°æ®

ä¿®æ”¹`data_model.py`çš„`_load_from_file`ï¼š

```python
def _load_from_file(self, data: Dict):
    # ...
    
    if 'CalculateDataList' in data and len(data['CalculateDataList']) > 0:
        formula = data.get('CalculateFormula')
        
        if formula == 101:  # SingleCycle - å¤šå¾ªç¯æ•°æ®
            # åŠ è½½æ‰€æœ‰æ ·æœ¬å¹¶æ„å»ºå®½è¡¨
            self.dataframe = self._build_multicycle_dataframe(data['CalculateDataList'])
        elif formula in [102, 103]:  # Bivariate - å¤šæµ“åº¦æ•°æ®
            # åŠ è½½æ‰€æœ‰æµ“åº¦å¹¶æ„å»ºå®½è¡¨
            self.dataframe = self._build_multiconcentration_dataframe(data['CalculateDataList'])
        else:
            # å›é€€ï¼šåªåŠ è½½ç¬¬ä¸€ä¸ªæ ·æœ¬
            base_data = data['CalculateDataList'][0].get('BaseData', [])
            self.dataframe = pd.DataFrame(base_data)
```

### æ–¹æ¡ˆ3ï¼šä¿®å¤å•æ ·æœ¬è½¬å®½è¡¨çš„æµ“åº¦å€¼

å¦‚æœå¿…é¡»æ”¯æŒå•æ ·æœ¬ + LocalBivariateï¼Œè‡³å°‘è¦ç”¨éé›¶æµ“åº¦ï¼š

```python
# â­ ä»Dataçš„attributesè·å–å®é™…æµ“åº¦
concentration = data_obj.attributes.get('calculatedatalist_concentration', 1.0)
if concentration is None or concentration <= 0:
    concentration = 1.0  # é»˜è®¤éé›¶å€¼
    
wide_df = pd.DataFrame({
    'Time': df[time_col],
    str(concentration): df[value_col]  # â† ä½¿ç”¨å®é™…æµ“åº¦ï¼Œä¸æ˜¯'0.0'
})
```

---

## ğŸ“Š é—®é¢˜æ€»ç»“

| é—®é¢˜ | å½“å‰çŠ¶æ€ | åº”è¯¥æ˜¯ |
|------|---------|--------|
| æ•°æ®åŠ è½½ | åªåŠ è½½ç¬¬ä¸€ä¸ªæ ·æœ¬ | æ ¹æ®ç®—æ³•ç±»å‹åŠ è½½æ‰€æœ‰æ ·æœ¬ |
| ç®—æ³•é€‰æ‹© | æ‰‹åŠ¨é€‰LocalBivariate | æ ¹æ®CalculateFormulaè‡ªåŠ¨é€‰ |
| æµ“åº¦å€¼ | ä½¿ç”¨'0.0'å ä½ | ä½¿ç”¨å®é™…æµ“åº¦æˆ–éé›¶é»˜è®¤å€¼ |
| æ•°æ®æ ¼å¼ | å•åˆ—ï¼ˆTime, YValueï¼‰ | å®½è¡¨ï¼ˆTime, æµ“åº¦1, æµ“åº¦2, ...ï¼‰ |

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³æ£€æŸ¥**ï¼šJSONä¸­å…¶ä»–7ä¸ªæ ·æœ¬çš„æµ“åº¦å’Œæ•°æ®
2. **ä¿®æ”¹åŠ è½½é€»è¾‘**ï¼šæ”¯æŒå¤šæ ·æœ¬æ•°æ®çš„æ­£ç¡®æ„å»º
3. **å®ç°ç®—æ³•è·¯ç”±**ï¼šæ ¹æ®CalculateFormulaè‡ªåŠ¨é€‰æ‹©ç®—æ³•
4. **æµ‹è¯•SingleCycle**ï¼šéªŒè¯SingleCycleç®—æ³•æ˜¯å¦å¯ç”¨

---

## ğŸ“ å‚è€ƒ

- `model_data_process/LocalBivariate.py` - LocalBivariateç®—æ³•å®ç°
- `XlementFitting/SingleCycle.py` - SingleCycleç®—æ³•å®ç°
- `XlementFitting/FileProcess/Json2excelSingleCycle.py` - å•å¾ªç¯æ•°æ®è½¬æ¢
- `src/models/data_model.py` ç¬¬143è¡Œ - å½“å‰åŠ è½½é€»è¾‘
- `src/utils/fitting_wrapper.py` ç¬¬148è¡Œ - å•æ ·æœ¬è½¬å®½è¡¨é€»è¾‘

