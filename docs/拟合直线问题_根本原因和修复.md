# æ‹Ÿåˆç›´çº¿é—®é¢˜çš„æ ¹æœ¬åŸå› å’Œä¿®å¤æ–¹æ¡ˆ

## ğŸ¯ é—®é¢˜æ ¹æº

**æ‹Ÿåˆç»“æœæ˜¯ç›´çº¿çš„çœŸæ­£åŸå› **ï¼š`time_break`å‚æ•°é”™è¯¯æˆ–æœªè®¾ç½®ï¼

### åŸé¡¹ç›®çš„ç¡¬ç¼–ç é—®é¢˜

`model_data_process/LocalBivariate.py` ç¬¬117è¡Œï¼š
```python
time_break = 133  # ç¡¬ç¼–ç ï¼
```

è¿™ä¸ª`time_break`æ˜¯**SPRå®éªŒçš„ç»“åˆ-è§£ç¦»åˆ†å‰²æ—¶é—´ç‚¹**ï¼Œå¯¹æ‹Ÿåˆç»“æœå½±å“å·¨å¤§ï¼å¦‚æœè®¾ç½®é”™è¯¯ï¼Œæ‹Ÿåˆä¼šé€€åŒ–ä¸ºç®€å•çš„çº¿æ€§æ‹Ÿåˆã€‚

### JSONæ•°æ®ä¸­çš„å®é™…å€¼

æ£€æŸ¥ç”¨æˆ·çš„JSONæ•°æ®ï¼š
```python
CombineEndIndex: 0  # æœªè®¾ç½®ï¼
```

è¿™è¯´æ˜ï¼š
1. JSONæ•°æ®ä¸­æ²¡æœ‰æ­£ç¡®è®¾ç½®time_break
2. å¿…é¡»ä»æ•°æ®ä¸­è‡ªåŠ¨ä¼°è®¡

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä»Dataå¯¹è±¡è·å–time_break

ä¿®æ”¹ `src/utils/fitting_wrapper.py`ï¼š

```python
# 1. ä»data_objçš„attributesè·å–
data_obj = kwargs.get('data_obj', None)
time_break = None
if data_obj and hasattr(data_obj, 'attributes'):
    combine_end = data_obj.attributes.get('calculatedatalist_combineendindex')
    if combine_end is not None and combine_end > 0:
        time_break = float(combine_end)
```

### æ–¹æ¡ˆ2ï¼šä»æ•°æ®è‡ªåŠ¨ä¼°è®¡time_break

æ·»åŠ ä¼°è®¡æ–¹æ³•ï¼š
```python
def _estimate_time_break(self, x_data, y_data):
    """
    ä»æ•°æ®ä¼°è®¡time_breakï¼ˆç»“åˆ-è§£ç¦»åˆ†å‰²æ—¶é—´ç‚¹ï¼‰
    ç­–ç•¥ï¼šæ‰¾åˆ°Yå€¼è¾¾åˆ°æœ€å¤§å€¼çš„ä½ç½®
    """
    max_idx = np.argmax(y_data)
    time_break = float(x_data[max_idx])
    return time_break
```

### æ–¹æ¡ˆ3ï¼šåˆ›å»ºå¢å¼ºç‰ˆmodel_runner

ç”±äºåŸå§‹`model_runner`ä¸æ¥å—å‚æ•°ï¼Œåˆ›å»ºä¸€ä¸ªwrapperï¼š
```python
def _model_runner_with_time_break(self, filename, time_break):
    """
    å¢å¼ºç‰ˆmodel_runnerï¼Œå¯æŒ‡å®štime_breakå‚æ•°
    """
    # å¤åˆ¶LocalBivariateçš„æ ¸å¿ƒé€»è¾‘
    # ä½†ä½¿ç”¨ä¼ å…¥çš„time_breakè€Œéç¡¬ç¼–ç 
    ...
    result = minimize(Loss_local_in_one, initial_guess, 
                      args=(A_data, T_data, Y_data, time_break),  # â† ä½¿ç”¨ä¼ å…¥å€¼
                      method='BFGS')
    ...
```

---

## âœ… å·²å®æ–½çš„ä¿®æ”¹

### 1. Controllerä¼ é€’data_obj

`src/controllers/main_controller_full.py` ç¬¬630è¡Œï¼š
```python
fit_result = fit_data(method, x_data, y_data, dataframe=data.dataframe, data_obj=data)
```

### 2. Fitting Wrapperæå–time_break

`src/utils/fitting_wrapper.py` ç¬¬96-106è¡Œï¼š
```python
# â­ ä»kwargsä¸­è·å–Dataå¯¹è±¡ï¼Œæå–SPRå‚æ•°
data_obj = kwargs.get('data_obj', None)
time_break = None
if data_obj and hasattr(data_obj, 'attributes'):
    combine_end = data_obj.attributes.get('calculatedatalist_combineendindex')
    if combine_end is not None and combine_end > 0:
        time_break = float(combine_end)
        print(f"[FittingWrapper] âœ… ä»Dataè·å–time_break={time_break}")
    else:
        print(f"[FittingWrapper] âš ï¸ CombineEndIndex={combine_end}ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼")
```

### 3. æ·»åŠ è‡ªåŠ¨ä¼°è®¡æ–¹æ³•

`src/utils/fitting_wrapper.py` ç¬¬341-353è¡Œï¼š
```python
def _estimate_time_break(self, x_data, y_data):
    try:
        max_idx = np.argmax(y_data)
        time_break = float(x_data[max_idx])
        print(f"[FittingWrapper] ä¼°è®¡time_break: max_idx={max_idx}, time_break={time_break}")
        return time_break
    except Exception as e:
        print(f"[FittingWrapper] ä¼°è®¡time_breakå¤±è´¥: {e}ï¼Œä½¿ç”¨é»˜è®¤å€¼133")
        return 133.0
```

### 4. æ·»åŠ å¢å¼ºç‰ˆmodel_runner

`src/utils/fitting_wrapper.py` ç¬¬355-445è¡Œï¼š
```python
def _model_runner_with_time_break(self, filename, time_break):
    """
    å¢å¼ºç‰ˆmodel_runnerï¼Œå¯æŒ‡å®štime_breakå‚æ•°
    """
    # ... (å¤åˆ¶LocalBivariateæ ¸å¿ƒé€»è¾‘)
    
    # â­ ä½¿ç”¨ä¼ å…¥çš„time_breakï¼Œè€Œéç¡¬ç¼–ç 
    print(f"[FittingWrapper] ä½¿ç”¨time_break={time_break}è¿›è¡Œæ‹Ÿåˆ")
    
    result = minimize(Loss_local_in_one, initial_guess, 
                      args=(A_data, T_data, Y_data, time_break),  # â† å…³é”®ï¼
                      method='BFGS',options={'eps': 1e-3})
    ...
```

### 5. ä¿®æ”¹è°ƒç”¨é€»è¾‘

`src/utils/fitting_wrapper.py` ç¬¬174-182è¡Œï¼š
```python
# â­ ä½¿ç”¨å¢å¼ºç‰ˆmodel_runnerï¼ˆå¯ä¼ é€’time_breakï¼‰
if time_break is not None:
    print(f"[FittingWrapper] âœ… ä½¿ç”¨æŒ‡å®štime_break={time_break}")
    result = self._model_runner_with_time_break(tmp_path, time_break)
else:
    # å›é€€ï¼šä¼°è®¡time_break
    estimated_break = self._estimate_time_break(x_data, y_data)
    print(f"[FittingWrapper] âš ï¸ ä¼°è®¡time_break={estimated_break}")
    result = self._model_runner_with_time_break(tmp_path, estimated_break)
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

è¿è¡Œæ‹Ÿåˆæ—¶åº”è¯¥çœ‹åˆ°ï¼š

### æƒ…å†µ1ï¼šJSONä¸­æœ‰time_break
```
[FittingWrapper] âœ… ä»Dataè·å–time_break=200.0
[FittingWrapper] âœ… ä½¿ç”¨æŒ‡å®štime_break=200.0
[FittingWrapper] ä½¿ç”¨time_break=200.0è¿›è¡Œæ‹Ÿåˆ
Rmax: 45.2340
kon: 1.2345e+05
koff: 2.3456e-03
KD: 1.9012e-08
```

### æƒ…å†µ2ï¼šJSONä¸­time_break=0æˆ–Noneï¼ˆå½“å‰æƒ…å†µï¼‰
```
[FittingWrapper] âš ï¸ CombineEndIndex=0ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼
[FittingWrapper] ä¼°è®¡time_break: max_idx=150, time_break=150.0
[FittingWrapper] âš ï¸ ä¼°è®¡time_break=150.0
[FittingWrapper] ä½¿ç”¨time_break=150.0è¿›è¡Œæ‹Ÿåˆ
Rmax: 45.2340
kon: 1.2345e+05
koff: 2.3456e-03
KD: 1.9012e-08
```

---

## ğŸ‰ é¢„æœŸæ•ˆæœ

ä¿®å¤åï¼Œæ‹Ÿåˆæ›²çº¿åº”è¯¥ï¼š
1. **ä¸å†æ˜¯ç›´çº¿**ï¼Œè€Œæ˜¯ç¬¦åˆSPRåŠ¨åŠ›å­¦çš„å…¸å‹å½¢çŠ¶
2. **ç»“åˆé˜¶æ®µ**ï¼ˆ0 â†’ time_breakï¼‰ï¼šæŒ‡æ•°ä¸Šå‡
3. **è§£ç¦»é˜¶æ®µ**ï¼ˆtime_break â†’ endï¼‰ï¼šæŒ‡æ•°ä¸‹é™
4. å½¢çŠ¶ç±»ä¼¼äºæ—§é¡¹ç›®ä¸­çš„æ­£ç¡®æ‹Ÿåˆç»“æœ

---

## ğŸ“ åç»­æ”¹è¿›å»ºè®®

1. **é•¿æœŸæ–¹æ¡ˆ**ï¼šä¿®æ”¹ `model_data_process/LocalBivariate.py`ï¼Œè®©`model_runner`æ¥å—`time_break`å‚æ•°
2. **æ•°æ®éªŒè¯**ï¼šåœ¨åŠ è½½JSONæ—¶éªŒè¯`CombineEndIndex`çš„æœ‰æ•ˆæ€§
3. **ç”¨æˆ·ç•Œé¢**ï¼šæ·»åŠ æ‰‹åŠ¨è®¾ç½®time_breakçš„é€‰é¡¹
4. **æ™ºèƒ½ä¼°è®¡**ï¼šæ”¹è¿›è‡ªåŠ¨ä¼°è®¡ç®—æ³•ï¼Œè€ƒè™‘ä¿¡å·å¯¼æ•°æˆ–æ›²ç‡å˜åŒ–

---

## ğŸ” é—®é¢˜æ’æŸ¥æ¸…å•

å¦‚æœæ‹Ÿåˆä»ç„¶ä¸æ­£ç¡®ï¼Œæ£€æŸ¥ï¼š

- [ ] æ§åˆ¶å°æ˜¯å¦æ‰“å°äº†`time_break`çš„å€¼ï¼Ÿ
- [ ] `time_break`çš„å€¼æ˜¯å¦åˆç†ï¼ˆé€šå¸¸åœ¨æ•°æ®æ—¶é—´èŒƒå›´å†…ï¼‰ï¼Ÿ
- [ ] DataFrameæ˜¯å¦æ­£ç¡®è½¬æ¢ä¸ºå®½è¡¨æ ¼å¼ï¼Ÿ
- [ ] Yé¢„æµ‹å€¼æ˜¯å¦ä»ç„¶æ˜¯ç›´çº¿ï¼ˆæ‰“å°å‰5ä¸ªå€¼ï¼‰ï¼Ÿ
- [ ] åŸå§‹Yæ•°æ®çš„å½¢çŠ¶æ˜¯å¦ç¬¦åˆSPRæ›²çº¿ç‰¹å¾ï¼Ÿ

---

## ä¿®æ”¹æ–‡ä»¶æ¸…å•

1. âœ… `src/controllers/main_controller_full.py` - ä¼ é€’data_obj
2. âœ… `src/utils/fitting_wrapper.py` - æ·»åŠ time_breakå¤„ç†é€»è¾‘
3. âœ… `docs/time_breaké—®é¢˜åˆ†æ.md` - é—®é¢˜åˆ†ææ–‡æ¡£
4. âœ… `docs/æ‹Ÿåˆç›´çº¿é—®é¢˜_æ ¹æœ¬åŸå› å’Œä¿®å¤.md` - ä¿®å¤æ€»ç»“æ–‡æ¡£

