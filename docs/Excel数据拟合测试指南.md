# Excel数据拟合测试指南

## 🎯 测试目标
验证使用旧项目的Excel数据（ctla-4测Cad(150KD)-146st0.xlsx）在新GUI中进行LocalBivariate拟合的完整流程。

---

## ✅ 已修复的问题

### 1. time_break硬编码问题
- **原问题**：`LocalBivariate.py`中`time_break=133`硬编码，不适用于所有数据
- **修复**：自动估计time_break（找到Y值最大值的时间点）
- **结果**：对于Excel数据，time_break=140（正确）

### 2. 拟合参数未返回
- **原问题**：`model_runner`只打印参数，不返回
- **修复**：修改返回格式为字典，包含`parameters`字段
- **结果**：可以在GUI中显示Rmax, kon, koff, KD

### 3. fitting_wrapper未提取参数
- **原问题**：使用占位符'N/A'
- **修复**：从`model_runner`返回的字典中提取实际参数
- **结果**：参数正确显示

---

## 📊 测试数据

### Excel文件：`ctla-4测Cad(150KD)-146st0.xlsx`
- **数据点数**：424个时间点
- **浓度数**：6个（0, 3.33e-9, 6.67e-9, 1.33e-8, 2.67e-8, 5.33e-8）
- **Y值范围**：-4 ~ 119（典型SPR曲线）

### 命令行测试结果
```
time_break: 140.0 (自动估计)

拟合参数：
  Rmax: 126.9734 RU
  kon: 3.3815e+05 1/(M*s)
  koff: 1.7456e-04 1/s
  KD: 5.1623e-10 M

拟合质量：
  RMSE: 3.74
  R²: 0.9908  ← 极好！
```

---

## 🖥️ GUI测试步骤

### 步骤1：启动GUI
```bash
py app_full.py
```

### 步骤2：加载Excel数据

#### 方法A：通过菜单
1. 点击 **文件** → **打开数据**
2. 选择文件：`ctla-4测Cad(150KD)-146st0.xlsx`
3. 数据会自动加载到左侧数据树

#### 方法B：拖放（如果支持）
1. 直接拖动Excel文件到GUI窗口

### 步骤3：验证数据加载
在左侧数据树中，应该能看到：
- ✅ 数据节点名称：`ctla-4测Cad(150KD)-146st0.xlsx` 或类似
- ✅ 点击节点，右侧应显示数据预览（如果有）

### 步骤4：执行拟合

#### 方法A：通过菜单
1. 点击 **分析** → **拟合**
2. 在对话框中：
   - **数据源**：应该自动列出已加载的数据
   - **拟合方法**：选择 `LocalBivariate`
   - （可选）勾选多个数据源进行合并拟合
3. 点击 **确定**

#### 方法B：右键菜单（如果支持）
1. 在数据树中，右键点击数据节点
2. 选择 **拟合** → **LocalBivariate**

### 步骤5：检查拟合结果

#### 控制台输出
应该看到类似：
```
[AutoEstimate] time_break: 140.0 (Y_max at row 140)
Rmax: 126.9734
kon: 3.3815e+05
koff: 1.7456e-04
KD: 5.1623e-10

[FittingWrapper] ✅ 拟合成功:
   Rmax=126.97 RU
   kon=3.3815e+05 1/(M*s)
   koff=1.7456e-04 1/s
   KD=5.1623e-10 M
```

#### 结果对话框
应该显示：
- ✅ **Rmax**：126.9734 RU
- ✅ **kon**：3.3815e+05 1/(M*s)
- ✅ **koff**：1.7456e-04 1/s
- ✅ **KD**：5.1623e-10 M
- ✅ **DataSource**：数据名称
- ✅ **Method**：LocalBivariate

#### 结果Tab（如果有）
拟合结果应该自动添加到结果表格中

#### 拟合曲线绘制
- ✅ 原始数据（散点或折线）
- ✅ 拟合曲线（应该与原始数据拟合良好，不是直线）
- ✅ 曲线应该呈现典型的SPR形状（上升→峰值→下降）

---

## ⚠️ 可能的问题

### 问题1：数据加载后列名不正确
**症状**：第一列不是`Time`，而是`Unnamed: 0`
**解决**：在`data_model.py`的`_load_from_file`中添加列名处理

### 问题2：拟合时报错"DataFrame格式不正确"
**症状**：控制台显示期望`Time | 浓度1 | 浓度2 | ...`
**原因**：Excel第一列名不是`Time`
**解决**：确保加载时重命名第一列

### 问题3：拟合结果仍然是直线
**症状**：拟合曲线是y=x
**检查**：
1. 控制台是否显示`time_break`自动估计？
2. 是否显示拟合参数（Rmax, kon, koff, KD）？
3. Y_pred的标准差是否>0？

---

## 📝 测试检查清单

- [ ] GUI成功启动
- [ ] Excel数据成功加载
- [ ] 数据树中显示数据节点
- [ ] 拟合对话框中能看到数据源
- [ ] LocalBivariate拟合成功执行
- [ ] 控制台显示time_break自动估计
- [ ] 控制台显示拟合参数
- [ ] 结果对话框显示参数（非N/A）
- [ ] 拟合曲线正确绘制（非直线）
- [ ] R²接近0.99（高质量拟合）

---

## 🚀 下一步

如果Excel数据测试成功，接下来：
1. 分析为什么JSON数据拟合失败（数据格式问题）
2. 实现其他拟合算法（SingleCycle, GlobalBivariate等）
3. 优化结果显示和导出功能

