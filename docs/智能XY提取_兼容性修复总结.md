# æ™ºèƒ½XYæå– - æ‹Ÿåˆå…¼å®¹æ€§ä¿®å¤æ€»ç»“

## ğŸ“… å®Œæˆæ—¶é—´
2025-10-22

## ğŸ¯ é—®é¢˜èƒŒæ™¯

ç”¨æˆ·å‘ç°æ™ºèƒ½XYæå–åŠŸèƒ½å¯èƒ½å½±å“æ‹Ÿåˆç®—æ³•ï¼Œå› ä¸ºï¼š
1. âŒ æ™ºèƒ½é€‰æ‹©å¯èƒ½é€‰é”™åˆ—
2. âŒ æ•°æ®è¢«è‡ªåŠ¨æ’åºï¼ˆå½±å“ä¾èµ–é¡ºåºçš„ç®—æ³•ï¼‰
3. âŒ NaNè¢«è‡ªåŠ¨è¿‡æ»¤ï¼ˆé•¿åº¦ä¸ä¸€è‡´ï¼‰
4. âŒ ç¼ºä¹æ‹Ÿåˆå‰çš„æ•°æ®éªŒè¯

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. å¢å¼º `get_xy_data()` æ–¹æ³•

**æ–‡ä»¶**: `src/models/data_model.py`

**æ–°å¢å‚æ•°**:
```python
def get_xy_data(
    self,
    x_col: Optional[str] = None,      # æ‰‹åŠ¨æŒ‡å®šXåˆ—
    y_col: Optional[str] = None,      # æ‰‹åŠ¨æŒ‡å®šYåˆ—
    auto_sort: bool = True,            # æ˜¯å¦è‡ªåŠ¨æ’åº
    drop_na: bool = True,              # æ˜¯å¦åˆ é™¤NaN
    return_info: bool = False          # æ˜¯å¦è¿”å›è¯¦ç»†ä¿¡æ¯
) -> Tuple[np.ndarray, np.ndarray]:
```

**åŠŸèƒ½**:
- âœ… **å‘åå…¼å®¹**: é»˜è®¤è¡Œä¸ºä¸å˜ï¼ˆæ™ºèƒ½é€‰æ‹© + æ’åº + åˆ é™¤NaNï¼‰
- âœ… **æ‰‹åŠ¨æ§åˆ¶**: å¯æŒ‡å®šX/Yåˆ—å
- âœ… **æ’åºæ§åˆ¶**: ç»˜å›¾ç”¨ `auto_sort=True`ï¼Œæ‹Ÿåˆç”¨ `auto_sort=False`
- âœ… **NaNæ§åˆ¶**: å¯é€‰æ‹©ä¿ç•™æˆ–åˆ é™¤NaN
- âœ… **è¯¦ç»†ä¿¡æ¯**: `return_info=True` è¿”å›é€‰æ‹©çš„åˆ—ã€ç»Ÿè®¡ä¿¡æ¯ç­‰

**ä½¿ç”¨ç¤ºä¾‹**:
```python
# ç»˜å›¾ç”¨ï¼ˆé»˜è®¤ï¼‰
x, y = data.get_xy_data()

# æ‹Ÿåˆç”¨ï¼ˆä¿æŒåŸé¡ºåºï¼‰
x, y = data.get_xy_data(auto_sort=False)

# æ‰‹åŠ¨æŒ‡å®šåˆ—
x, y = data.get_xy_data(x_col='Time', y_col='Response')

# è·å–è¯¦ç»†ä¿¡æ¯
x, y, info = data.get_xy_data(return_info=True)
print(f"é€‰æ‹©çš„åˆ—: {info['x_col']}, {info['y_col']}")
print(f"æœ‰æ•ˆç‚¹æ•°: {info['valid_points']}")
```

---

### 2. æ–°å¢ `validate_xy_extraction()` æ–¹æ³•

**æ–‡ä»¶**: `src/models/data_model.py`

**åŠŸèƒ½**: åœ¨ä¸å®é™…æå–æ•°æ®çš„æƒ…å†µä¸‹ï¼Œè¿”å›å°†ä¼šæå–ä»€ä¹ˆæ•°æ®

**è¿”å›ä¿¡æ¯**:
```python
{
    'x_col': 'Time',           # å°†ä½¿ç”¨çš„Xåˆ—
    'y_col': 'Response',       # å°†ä½¿ç”¨çš„Yåˆ—
    'total_points': 100,       # DataFrameæ€»è¡Œæ•°
    'valid_both': 93,          # Xå’ŒYéƒ½æœ‰æ•ˆçš„ç‚¹æ•°
    'na_count': 7,             # ç¼ºå¤±å€¼æ•°é‡
    'warnings': [...],         # è­¦å‘Šåˆ—è¡¨
    'y_candidates': [...],     # å…¶ä»–å¯é€‰Yåˆ—
    'columns_info': {...}      # æ‰€æœ‰åˆ—çš„è¯¦ç»†ä¿¡æ¯
}
```

**è­¦å‘Šç±»å‹**:
- æ•°æ®ç‚¹è¿‡å°‘ï¼ˆ<3ä¸ªï¼šå¼ºåˆ¶é˜»æ­¢æ‹Ÿåˆï¼›<10ä¸ªï¼šå»ºè®®ï¼‰
- ç¼ºå¤±å€¼è¾ƒå¤šï¼ˆ>50%ï¼‰
- å­˜åœ¨å¤šä¸ªå€™é€‰Yåˆ—ï¼ˆéœ€è¦ç”¨æˆ·ç¡®è®¤ï¼‰

**ä½¿ç”¨ç¤ºä¾‹**:
```python
# æ‹Ÿåˆå‰éªŒè¯
validation = data.validate_xy_extraction()

if validation['warnings']:
    print("è­¦å‘Š:", validation['warnings'])
    print(f"å°†ä½¿ç”¨: X={validation['x_col']}, Y={validation['y_col']}")
    
if validation['valid_both'] < 10:
    print("æ•°æ®ç‚¹å¤ªå°‘ï¼Œæ‹Ÿåˆå¯èƒ½ä¸å‡†ç¡®")
```

---

### 3. Controllerä¸­æ·»åŠ æ‹Ÿåˆå‰æ£€æŸ¥

**æ–‡ä»¶**: `src/controllers/main_controller_full.py`

**ä½ç½®**: `on_fit_data()` æ–¹æ³•ï¼Œåœ¨è°ƒç”¨æ‹Ÿåˆç®—æ³•å‰

**é€»è¾‘**:
```python
# 1. è°ƒç”¨ validate_xy_extraction() éªŒè¯æ•°æ®
validation = data.validate_xy_extraction()

# 2. æ£€æŸ¥ä¸¥é‡é”™è¯¯
if 'error' in validation:
    æ˜¾ç¤ºé”™è¯¯å¹¶è¿”å›

# 3. å¤„ç†è­¦å‘Š
if validation['warnings']:
    # æ•°æ®ç‚¹<3: å¼ºåˆ¶é˜»æ­¢æ‹Ÿåˆ
    if validation['valid_both'] < 3:
        æ˜¾ç¤ºé”™è¯¯å¹¶è¿”å›
    
    # å…¶ä»–è­¦å‘Š: è¯¢é—®ç”¨æˆ·æ˜¯å¦ç»§ç»­
    reply = QMessageBox.warning(...)
    if reply != Yes:
        return

# 4. æå–æ•°æ®ï¼ˆæ‹Ÿåˆç”¨ï¼Œä¸æ’åºï¼‰
x_data, y_data = data.get_xy_data(auto_sort=False)

# 5. æ‰§è¡Œæ‹Ÿåˆ
fit_result = fit_data(...)
```

**ç”¨æˆ·ä½“éªŒ**:
- æ‹Ÿåˆå‰è‡ªåŠ¨æ£€æŸ¥æ•°æ®
- æ˜¾ç¤ºå°†ä½¿ç”¨çš„åˆ—å’Œæ•°æ®ç‚¹æ•°
- æä¾›å¤‡é€‰Yåˆ—ä¾›å‚è€ƒ
- æ•°æ®ä¸è¶³æ—¶å¼ºåˆ¶é˜»æ­¢æ‹Ÿåˆ
- å…¶ä»–è­¦å‘Šè¯¢é—®ç”¨æˆ·ç¡®è®¤

---

## ğŸ“Š æµ‹è¯•éªŒè¯

### æµ‹è¯•æ–‡ä»¶
- `tests/test_xy_extraction_compatibility.py`

### æµ‹è¯•é¡¹ç›®
1. âœ… **æ‰‹åŠ¨æŒ‡å®šåˆ— vs æ™ºèƒ½é€‰æ‹©** - é€šè¿‡
2. âœ… **æ’åºæ§åˆ¶ï¼ˆauto_sortï¼‰** - é€šè¿‡
3. âœ… **NaNå¤„ç†ï¼ˆdrop_naï¼‰** - é€šè¿‡
4. âœ… **æ•°æ®éªŒè¯åŠŸèƒ½** - é€šè¿‡
5. âœ… **å®Œæ•´æ‹Ÿåˆæµç¨‹** - é€šè¿‡

### æµ‹è¯•ç»“æœ
```
[PASS] æ‰‹åŠ¨æŒ‡å®šåˆ—åŠŸèƒ½æ­£å¸¸
[PASS] æ’åºæ§åˆ¶åŠŸèƒ½æ­£å¸¸
[PASS] NaNå¤„ç†åŠŸèƒ½æ­£å¸¸
[PASS] æ•°æ®éªŒè¯åŠŸèƒ½æ­£å¸¸
[PASS] æ‹Ÿåˆæµç¨‹åŠŸèƒ½æ­£å¸¸
```

---

## ğŸ”§ å…³é”®ä¿®å¤ç‚¹

### é—®é¢˜1ï¼šåˆ—é€‰æ‹©é”™è¯¯
**ä¿®å¤**: 
- æ”¯æŒæ‰‹åŠ¨æŒ‡å®šåˆ—ï¼š`get_xy_data(y_col='Response')`
- æä¾›å¤‡é€‰åˆ—åˆ—è¡¨ï¼š`validation['y_candidates']`

### é—®é¢˜2ï¼šæ•°æ®è¢«æ’åº
**ä¿®å¤**: 
- ç»˜å›¾æ—¶ï¼š`get_xy_data(auto_sort=True)` âœ… æ’åºï¼Œé¿å…æŠ˜çº¿æ··ä¹±
- æ‹Ÿåˆæ—¶ï¼š`get_xy_data(auto_sort=False)` âœ… ä¿æŒåŸé¡ºåº

### é—®é¢˜3ï¼šNaNè¢«è¿‡æ»¤
**ä¿®å¤**: 
- é»˜è®¤ï¼š`drop_na=True` åˆ é™¤NaNï¼ˆå¤§å¤šæ•°ç®—æ³•éœ€è¦ï¼‰
- å¯é€‰ï¼š`drop_na=False` ä¿ç•™NaNï¼ˆç‰¹æ®Šç®—æ³•ï¼‰
- éªŒè¯æ—¶æç¤ºè¿‡æ»¤çš„æ•°æ®ç‚¹æ•°

### é—®é¢˜4ï¼šç¼ºä¹éªŒè¯
**ä¿®å¤**: 
- æ‹Ÿåˆå‰è‡ªåŠ¨è°ƒç”¨ `validate_xy_extraction()`
- æ˜¾ç¤ºè­¦å‘Šå¯¹è¯æ¡†
- æ•°æ®ä¸è¶³æ—¶å¼ºåˆ¶é˜»æ­¢æ‹Ÿåˆ

---

## ğŸ“‹ æ–‡ä»¶å˜æ›´æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶
1. âœ… `src/models/data_model.py` 
   - å¢å¼º `get_xy_data()` - æ·»åŠ 4ä¸ªå¯é€‰å‚æ•°
   - æ–°å¢ `validate_xy_extraction()` æ–¹æ³•

2. âœ… `src/controllers/main_controller_full.py`
   - `on_fit_data()` ä¸­æ·»åŠ æ‹Ÿåˆå‰éªŒè¯
   - ä½¿ç”¨ `auto_sort=False` æå–æ‹Ÿåˆæ•°æ®

### æ–°å¢çš„æ–‡ä»¶
1. âœ… `tests/test_xy_extraction_compatibility.py` - å…¼å®¹æ€§æµ‹è¯•
2. âœ… `docs/æ™ºèƒ½XYæå–_æ‹Ÿåˆå…¼å®¹æ€§åˆ†æ.md` - è¯¦ç»†åˆ†ææ–‡æ¡£
3. âœ… `docs/æ™ºèƒ½XYæå–_å…¼å®¹æ€§ä¿®å¤æ€»ç»“.md` - æœ¬æ–‡æ¡£

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### åœºæ™¯1ï¼šç»˜å›¾ï¼ˆé»˜è®¤è¡Œä¸ºï¼‰
```python
# æ™ºèƒ½é€‰æ‹©åˆ— + æ’åº + åˆ é™¤NaN
x, y = data.get_xy_data()
plt.plot(x, y)
```

### åœºæ™¯2ï¼šæ‹Ÿåˆï¼ˆä¿æŒåŸé¡ºåºï¼‰
```python
# éªŒè¯æ•°æ®
validation = data.validate_xy_extraction()
if validation['warnings']:
    print("è­¦å‘Š:", validation['warnings'])

# æå–æ•°æ®ï¼ˆä¸æ’åºï¼‰
x, y = data.get_xy_data(auto_sort=False)

# æ‰§è¡Œæ‹Ÿåˆ
result = fit_data('LocalBivariate', x, y, dataframe=data.dataframe)
```

### åœºæ™¯3ï¼šæ‰‹åŠ¨æŒ‡å®šåˆ—
```python
# ç”¨æˆ·æ˜ç¡®çŸ¥é“è¦ç”¨å“ªåˆ—
x, y = data.get_xy_data(
    x_col='Time', 
    y_col='Response',
    auto_sort=False  # æ‹Ÿåˆç”¨
)
```

### åœºæ™¯4ï¼šè°ƒè¯•æ•°æ®æå–
```python
# è·å–è¯¦ç»†ä¿¡æ¯
x, y, info = data.get_xy_data(return_info=True)

print(f"é€‰æ‹©çš„åˆ—: X={info['x_col']}, Y={info['y_col']}")
print(f"æ€»æ•°æ®ç‚¹: {info['total_points']}")
print(f"æœ‰æ•ˆç‚¹æ•°: {info['valid_points']}")
print(f"è¿‡æ»¤æ‰: {info['dropped_na']}ä¸ªNaN")
print(f"å¤‡é€‰Yåˆ—: {info['y_candidates']}")
```

---

## âœ¨ ä¼˜åŠ¿æ€»ç»“

1. **å‘åå…¼å®¹**: ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹ï¼Œé»˜è®¤è¡Œä¸ºä¸å˜
2. **çµæ´»æ§åˆ¶**: æ”¯æŒæ‰‹åŠ¨æŒ‡å®šåˆ—ã€æ§åˆ¶æ’åºå’ŒNaNå¤„ç†
3. **ç”¨æˆ·å‹å¥½**: æ‹Ÿåˆå‰è‡ªåŠ¨éªŒè¯ï¼Œæä¾›æ¸…æ™°çš„è­¦å‘Šä¿¡æ¯
4. **è°ƒè¯•æ–¹ä¾¿**: `return_info=True` æä¾›è¯¦ç»†çš„æå–ä¿¡æ¯
5. **å®‰å…¨å¯é **: æ•°æ®ä¸è¶³æ—¶å¼ºåˆ¶é˜»æ­¢æ‹Ÿåˆï¼Œé¿å…ç®—æ³•å´©æºƒ

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **æ‹Ÿåˆæ—¶åŠ¡å¿…ä½¿ç”¨ `auto_sort=False`**
   - æŸäº›ç®—æ³•ä¾èµ–æ•°æ®çš„åŸå§‹æ—¶é—´é¡ºåº
   - æ’åºå¯èƒ½å¯¼è‡´æ‹Ÿåˆç»“æœé”™è¯¯

2. **å…³æ³¨è­¦å‘Šä¿¡æ¯**
   - å¤šä¸ªå€™é€‰Yåˆ—æ—¶ï¼Œç¡®è®¤æ™ºèƒ½é€‰æ‹©æ˜¯å¦æ­£ç¡®
   - æ•°æ®ç‚¹è¿‡å°‘æ—¶ï¼Œæ‹Ÿåˆç²¾åº¦ä¼šé™ä½

3. **æ‰‹åŠ¨æŒ‡å®šåˆ—çš„åœºæ™¯**
   - JSONæ•°æ®ï¼šåˆ—åå›ºå®šï¼Œå¯ä»¥æ‰‹åŠ¨æŒ‡å®š
   - ç”¨æˆ·é€‰æ‹©ï¼šUIæä¾›åˆ—é€‰æ‹©å™¨
   - è°ƒè¯•ï¼šæ˜ç¡®çŸ¥é“è¦ç”¨å“ªåˆ—

4. **DataFrameæ ¼å¼è¦æ±‚**
   - LocalBivariateç®—æ³•æœŸæœ›ç‰¹å®šæ ¼å¼ï¼ˆTime + æµ“åº¦åˆ—ï¼‰
   - `fitting_wrapper.py` ä¼šè‡ªåŠ¨æ£€æµ‹å’Œé€‚é…æ ¼å¼

---

## ğŸ¯ åç»­å»ºè®®

1. åœ¨UIä¸­æ·»åŠ "åˆ—é€‰æ‹©å™¨"ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
2. è®°å½•ç”¨æˆ·çš„åˆ—é€‰æ‹©åå¥½
3. ä¸ºä¸åŒçš„æ‹Ÿåˆç®—æ³•æä¾›æ ¼å¼é€‚é…å™¨
4. æ·»åŠ æ•°æ®é¢„å¤„ç†åŠŸèƒ½ï¼ˆåŸºçº¿æ ¡æ­£ã€å¹³æ»‘ç­‰ï¼‰

---

**âœ… æ‰€æœ‰å…¼å®¹æ€§é—®é¢˜å·²ä¿®å¤ï¼æ™ºèƒ½XYæå–ä¸æ‹Ÿåˆç®—æ³•ç°å·²å®Œå…¨å…¼å®¹ã€‚**

